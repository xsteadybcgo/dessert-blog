# React Fiberä¸­ä½¿ç”¨é“¾è¡¨éå†ç»„ä»¶æ ‘çš„æ–¹å¼å’ŒåŸå› 

### Reactè°ƒåº¦å™¨ä¸­å·¥ä½œå¾ªç¯çš„ä¸»è¦ç®—æ³•

![avatar](../assets/images/1_d8GcL9UNG0w9n_WW5TCWRw.png)
<font size=1><center>å·¥ä½œå¾ªç¯é…å›¾, æ¥è‡ª [Lin Clarkåœ¨ReactConf 2017çš„ç²¾å½©æ¼”è®²](https://www.youtube.com/watch?v=ZCuYPiUIONs) </center></font>


ä¸ºäº†æå‡è‡ªå·±ï¼Œä¿ƒè¿›ç¤¾åŒºå‘å±•ï¼Œæˆ‘èŠ±äº†å¾ˆå¤šæ—¶é—´ç”¨äºç ”ç©¶[WebæŠ€æœ¯é€†å‘å·¥ç¨‹](https://blog.angularindepth.com/practical-application-of-reverse-engineering-guidelines-and-principles-784c004bb657)å¹¶è®°å½•å…¶ä¸­çš„æˆæœã€‚åœ¨è¿‡å»çš„ä¸€å¹´é‡Œï¼Œæˆ‘ä¸»è¦ä¸“æ³¨äºAngularæºç ï¼Œå¹¶å‘å¸ƒäº†ç½‘ä¸Šæœ€å¤§çš„Angularå‡ºç‰ˆç‰©â€”[Angular-In-Depth](https://blog.angularindepth.com/)ã€‚**ç°åœ¨åˆ°äº†è¦æŠŠæŠŠä¸»è¦ç²¾åŠ›æŠ•å…¥åˆ°Reactä¸­çš„æ—¶å€™äº†**ã€‚æˆ‘éå¸¸äº†è§£angularæ¡†æ¶ä¸­çš„[å˜åŒ–æ£€æµ‹](https://medium.freecodecamp.org/what-every-front-end-developer-should-know-about-change-detection-in-angular-and-react-508f83f58c6a)çš„æœºåˆ¶ï¼Œæˆ‘å¸Œæœ›è‡ªå·±ä¿æŒè€å¿ƒï¼Œå¹¶é€šè¿‡å¤§é‡çš„æ–­ç‚¹è°ƒè¯•æ¥å¿«é€Ÿåœ¨Reacté¢†åŸŸä¹Ÿè¾¾åˆ°è¿™ä¸ªæ°´å¹³ã€‚

åœ¨Reactä¸­, å˜åŒ–æ£€æµ‹æœºåˆ¶é€šå¸¸ç§°ä¸º "åè°ƒ" æˆ– "æ¸²æŸ“"ï¼Œè€ŒFiberæ˜¯å…¶æœ€æ–°å®ç°ã€‚å½’åŠŸäºå®ƒçš„åº•å±‚æ¶æ„ï¼Œå®ƒæä¾›äº†å®ç°è®¸å¤šæœ‰è¶£çš„ç‰¹æ€§çš„èƒ½åŠ›ï¼Œæ¯”å¦‚æ‰§è¡Œéé˜»å¡æ¸²æŸ“ï¼Œæ ¹æ®ä¼˜å…ˆçº§æ‰§è¡Œæ›´æ–°ï¼Œåœ¨åå°é¢„æ¸²æŸ“å†…å®¹ç­‰ã€‚è¿™äº›ç‰¹æ€§åœ¨[Concurrent React å“²å­¦](https://twitter.com/acdlite/status/1056612147432574976)ä¸­è¢«ç§°ä¸º**æ—¶é—´ç‰‡**ã€‚

é™¤äº†è§£å†³åº”ç”¨ç¨‹åºå¼€å‘è€…çš„å®é™…é—®é¢˜ä¹‹å¤–ï¼Œ**ä»å·¥ç¨‹è§’åº¦æ¥çœ‹ï¼Œè¿™äº›æœºåˆ¶çš„å†…éƒ¨å®ç°ä¹Ÿå…·æœ‰å¹¿æ³›çš„å¸å¼•åŠ›ã€‚æºç ä¸­æœ‰å¦‚æ­¤ä¸°å¯Œçš„çŸ¥è¯†å¯ä»¥å¸®åŠ©æˆ‘ä»¬æˆé•¿ä¸ºæ›´å¥½çš„å¼€å‘è€…ã€‚**

å¦‚ä»Šä½ ç”¨è°·æ­Œæœç´¢â€œReact Fiberâ€ï¼Œä½ ä¼šåœ¨æœç´¢ç»“æœä¸­çœ‹åˆ°å¾ˆå¤šæ–‡ç« ã€‚ä½†æ˜¯é™¤äº†[Andrew Clarkçš„ç¬”è®°](https://github.com/acdlite/react-fiber-architecture)ï¼Œæ‰€æœ‰æ–‡ç« éƒ½æ˜¯ç«™åœ¨å¾ˆé«˜çš„å±‚æ¬¡è¿›è¡Œè§£è¯»ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å‚è€ƒAndrew Clarkçš„ç¬”è®°ï¼Œ**å¯¹Fiberä¸­ä¸€äº›ç‰¹åˆ«é‡è¦çš„æ¦‚å¿µè¿›è¡Œè¯¦ç»†è¯´æ˜**ã€‚ä¸€æ—¦æˆ‘ä»¬å®Œæˆè¿™äº›ä»»åŠ¡ï¼Œä½ å°†æ‹¥æœ‰è¶³å¤Ÿçš„çŸ¥è¯†æ¥ç†è§£[Lin Clarkåœ¨ReactConf 2017ä¸Šçš„ä¸€æ¬¡éå¸¸ç²¾å½©çš„æ¼”è®²](https://www.youtube.com/watch?v=ZCuYPiUIONs)ä¸­çš„å·¥ä½œå¾ªç¯é…å›¾ã€‚*è¿™æ˜¯ä½ å¿…çœ‹çš„ä¸€æ¬¡æ¼”è®²*ã€‚ä½†æ˜¯ï¼Œåœ¨ä½ èŠ±äº†ä¸€ç‚¹æ—¶é—´é˜…è¯»æœ¬æ–‡ä¹‹åï¼Œå®ƒå¯¹ä½ æ¥è¯´ä¼šæ›´å®¹æ˜“ç†è§£ã€‚

[è¿™ç¯‡æ–‡ç« å¼€å¯äº†ä¸€ä¸ªå…³äºReact Fiberå†…éƒ¨å®ç°çš„ç³»åˆ—æ–‡ç« ã€‚](https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e)æˆ‘å¤§çº¦æœ‰70%æ˜¯é€šè¿‡å†…éƒ¨å®ç°äº†è§£çš„ï¼Œæ­¤å¤–è¿˜çœ‹äº†ä¸‰ç¯‡å…³äºåè°ƒå’Œæ¸²æŸ“æœºåˆ¶çš„æ–‡ç« ã€‚

> æˆ‘åœ¨[ag-Grid](https://react-grid.ag-grid.com/?utm_source=medium&utm_medium=blog&utm_campaign=reactcustom)æ‹…ä»»å¼€å‘äººå‘˜ã€‚å¦‚æœä½ æƒ³äº†è§£æ•°æ®è¡¨æ ¼æˆ–å¯»æ‰¾ç»ˆæçš„Reactæ•°æ®è¡¨æ ¼è§£å†³æ–¹æ¡ˆï¼Œè¯·æŸ¥çœ‹è¿™ç¯‡æŒ‡å— â€œ[åœ¨5åˆ†é’Ÿå†…å¼€å§‹ä½¿ç”¨Reactç½‘æ ¼](http://blog.ag-grid.com/index.php/2018/08/07/get-started-with-react-grid-in-5-minutes/?utm_source=medium&utm_medium=blog&utm_campaign=getstartedreact)â€ã€‚
æˆ‘å¾ˆä¹æ„å›ç­”ä½ çš„ä»»ä½•é—®é¢˜ã€‚[è¯·å…³æ³¨æˆ‘ï¼](https://twitter.com/maxim_koretskyi)

è®©æˆ‘ä»¬å¼€å§‹å§!

___

### åŸºç¡€

Fiberçš„æ¶æ„æœ‰ä¸¤ä¸ªä¸»è¦é˜¶æ®µï¼šåè°ƒ(_reconciliation_)/æ¸²æŸ“(_render_)å’Œæäº¤(_commit_)ã€‚åœ¨æºç ä¸­ï¼Œ_reconciliation_ é˜¶æ®µé€šå¸¸è¢«ç§°ä¸ºâ€œ_render_ é˜¶æ®µâ€ã€‚è¿™æ˜¯Reactéå†ç»„ä»¶æ ‘çš„é˜¶æ®µï¼Œå¹¶ä¸”ï¼š

* æ›´æ–° _state_ å’Œ _props_ 
* è°ƒç”¨ç”Ÿå‘½å‘¨æœŸé’©å­
* è·å–ç»„ä»¶çš„`children`
* å°†å®ƒä»¬ä¸ä¹‹å‰çš„`children`è¿›è¡Œå¯¹æ¯”
* å¹¶è®¡ç®—å‡ºéœ€è¦æ‰§è¡Œçš„DOMæ›´æ–°

**ä¸Šè¿°è¿™äº›è¢«ç§°ä¸ºFiberå†…éƒ¨çš„å·¥ä½œã€‚** éœ€è¦å®Œæˆçš„å·¥ä½œç±»å‹å–å†³äºReact Elementçš„ç±»å‹ã€‚ ä¾‹å¦‚ï¼Œå¯¹äº
`Class Component` Reactéœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªç±»ï¼Œç„¶è€Œå¯¹äº`Functional Component`å´ä¸éœ€è¦ã€‚å¦‚æœæœ‰å…´è¶£ï¼Œ[åœ¨è¿™é‡Œ](https://github.com/facebook/react/blob/340bfd9393e8173adca5380e6587e1ea1a23cefa/packages/shared/ReactWorkTags.js#L29-L28)
ä½ å¯ä»¥çœ‹åˆ°Fiberä¸­çš„æ‰€æœ‰ç±»å‹çš„å·¥ä½œç›®æ ‡ã€‚ è¿™äº›æ´»åŠ¨æ­£æ˜¯Andrewåœ¨è¿™é‡Œè°ˆåˆ°çš„ï¼š

> åœ¨å¤„ç†UIæ—¶ï¼Œé—®é¢˜æ˜¯å¦‚æœ**ä¸€æ¬¡æ‰§è¡Œå¤ªå¤šå·¥ä½œ**ï¼Œå¯èƒ½ä¼šå¯¼è‡´åŠ¨ç”»ä¸¢å¸§...

å…·ä½“ä»€ä¹ˆæ˜¯*ä¸€æ¬¡æ‰§è¡Œå¤ªå¤š*ï¼Ÿå¥½å§ï¼ŒåŸºæœ¬ä¸Šï¼Œå¦‚æœReact**åŒæ­¥**åœ°éå†æ•´ä¸ªç»„ä»¶æ ‘å¹¶ä¸ºæ¯ä¸ªç»„ä»¶æ‰§è¡Œä»»åŠ¡ï¼Œæ‰§è¡Œå…¶é€»è¾‘çš„åº”ç”¨ç¨‹åºä»£ç å¯èƒ½éœ€è¦è¿è¡Œ16æ¯«ç§’ä»¥ä¸Šæ‰è¡Œã€‚è¿™å°†å¯¼è‡´ä¸¢å¸§çš„å¡é¡¿è§†è§‰æ„Ÿå—ã€‚

é‚£ä¹ˆæœ‰å¥½çš„åŠæ³•å—?

> è¾ƒæ–°çš„æµè§ˆå™¨ï¼ˆå’ŒReact Nativeï¼‰å®ç°äº†æœ‰åŠ©äºè§£å†³è¿™ä¸ªé—®é¢˜çš„API ...

ä»–æåˆ°çš„æ–°APIæ˜¯[requestIdleCallback](https://developers.google.com/web/updates/2015/08/using-requestidlecallback)
å…¨å±€å‡½æ•°ï¼Œå¯ç”¨äºå¯¹å‡½æ•°è¿›è¡Œæ’é˜Ÿï¼Œè¿™äº›å‡½æ•°ä¼šåœ¨æµè§ˆå™¨ç©ºé—²æ—¶è¢«è°ƒç”¨ã€‚ä»¥ä¸‹æ˜¯ä½ å°†å¦‚ä½•ä½¿ç”¨å®ƒ:

```js
requestIdleCallback((deadline)=>{
    console.log(deadline.timeRemaining(), deadline.didTimeout)
});
```

å¦‚æœæˆ‘ç°åœ¨æ‰“å¼€æ§åˆ¶å°å¹¶æ‰§è¡Œä¸Šé¢çš„ä»£ç ï¼ŒChromeä¼šæ‰“å°`49.9 false`ã€‚
å®ƒåŸºæœ¬ä¸Šå‘Šè¯‰æˆ‘ï¼Œæˆ‘æœ‰`49.9ms`å»åšæˆ‘éœ€è¦åšçš„ä»»ä½•å·¥ä½œï¼Œå¹¶ä¸”æˆ‘è¿˜æ²¡æœ‰ç”¨å®Œæ‰€æœ‰åˆ†é…çš„æ—¶é—´ï¼Œå¦åˆ™`deadline.didTimeout`
å°†è¿”å›`true`ã€‚è¯·è®°ä½`timeRemaining`å¯èƒ½åœ¨æµè§ˆå™¨è¢«åˆ†é…æŸäº›å·¥ä½œåç«‹å³æ›´æ”¹ï¼Œå› æ­¤åº”è¯¥ä¸æ–­æ£€æŸ¥ã€‚

> `requestIdleCallback` ï¼ˆè¿™ä¸ªapiï¼‰å®é™…ä¸Šæœ‰å¤ªå¤šé™åˆ¶ï¼Œå¹¶ä¸”[å®ƒçš„æ‰§è¡Œé¢‘æ¬¡ä¹Ÿä¸è¶³ä»¥](https://github.com/facebook/react/issues/13206#issuecomment-418923831)å®ç°æµç•…çš„UIæ¸²æŸ“ï¼Œå› æ­¤Reactå›¢é˜Ÿ[å¿…é¡»å®ç°è‡ªå·±çš„ç‰ˆæœ¬](https://github.com/facebook/react/blob/eeb817785c771362416fd87ea7d2a1a32dde9842/packages/scheduler/src/Scheduler.js#L212-L222)ã€‚

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬å°†Reactå¯¹ç»„ä»¶æ‰§è¡Œçš„æ‰€æœ‰æ´»åŠ¨æ”¾å…¥å‡½æ•°`performWork`, å¹¶ä½¿ç”¨`requestIdleCallback`æ¥å®‰æ’å·¥ä½œï¼Œæˆ‘ä»¬çš„ä»£ç å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š

```js
requestIdleCallback((deadline) => {
    // å½“æˆ‘ä»¬æœ‰æ—¶é—´æ—¶ï¼Œä¸ºç»„ä»¶æ ‘çš„ä¸€éƒ¨åˆ†æ‰§è¡Œå·¥ä½œ    
    while ((deadline.timeRemaining() > 0 || deadline.didTimeout) && nextComponent) {
        nextComponent = performWork(nextComponent);
    }
});
```

æˆ‘ä»¬å¤„ç†å®Œä¸€ä¸ªç»„ä»¶ï¼Œç„¶åè¿”å›è¦å¤„ç†çš„ä¸‹ä¸€ä¸ªç»„ä»¶çš„å¼•ç”¨ã€‚è¿™èƒ½å¤Ÿå¾ˆå¥½çš„å®Œæˆï¼Œä½†æœ‰ä¸€ä»¶äº‹æƒ…è¿˜æ— æ³•åŠåˆ°ã€‚æ­£å¦‚[æ—§ç‰ˆæœ¬åè°ƒç®—æ³•å®ç°](https://reactjs.org/docs/codebase-overview.html#stack-reconciler)ä¸­æ‰€ç¤ºï¼Œä½ ä¸èƒ½åŒæ­¥åœ°å¤„ç†æ•´ä¸ªç»„ä»¶æ ‘ã€‚
è¿™å°±æ˜¯Andrewåœ¨è¿™é‡Œè°ˆåˆ°çš„é—®é¢˜ï¼š

> ä¸ºäº†ä½¿ç”¨è¿™äº›APIï¼Œä½ éœ€è¦ä¸€ç§æ–¹æ³•å°†æ¸²æŸ“å·¥ä½œåˆ†è§£ä¸ºå¢é‡å•å…ƒ

å› æ­¤ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒReactå¿…é¡»é‡æ–°å®ç°éå†ç»„ä»¶æ ‘çš„ç®—æ³•ï¼Œ**ä»ä¾èµ–äºå†…ç½®æ ˆçš„åŒæ­¥é€’å½’æ¨¡å‹ï¼Œå˜ä¸ºå…·æœ‰é“¾è¡¨å’ŒæŒ‡é’ˆçš„å¼‚æ­¥æ¨¡å‹**ã€‚è¿™å°±æ˜¯Andrewåœ¨è¿™é‡Œå†™çš„ï¼š

> å¦‚æœä½ åªä¾èµ–äº[å†…ç½®]è°ƒç”¨æ ˆï¼Œå®ƒå°†ç»§ç»­å·¥ä½œç›´åˆ°æ ˆä¸ºç©º......å¦‚æœæˆ‘ä»¬å¯ä»¥éšæ„ä¸­æ–­è°ƒç”¨æ ˆå¹¶æ‰‹åŠ¨æ“ä½œæ ˆå¸§ï¼Œé‚£ä¸æ˜¯å¾ˆå¥½å—ï¼Ÿè¿™å°±æ˜¯React Fiberçš„ç›®çš„ã€‚ **Fiberæ˜¯ä¸“ä¸ºReactç»„ä»¶é‡æ–°å®ç°çš„æ ˆ**ã€‚ ä½ å¯ä»¥å°†å•ä¸ªFiberè§†ä¸ºä¸€ä¸ªè™šæ‹Ÿæ ˆå¸§ã€‚

è¿™å°±æ˜¯æˆ‘ç°åœ¨å°†è¦è®²è§£çš„å†…å®¹ã€‚
___

#### å…³äºæ ˆ

æˆ‘å‡è®¾ä½ ä»¬éƒ½ç†Ÿæ‚‰è°ƒç”¨æ ˆçš„æ¦‚å¿µã€‚å¦‚æœä½ åœ¨æ–­ç‚¹å¤„æš‚åœä»£ç ï¼Œåˆ™å¯ä»¥åœ¨æµè§ˆå™¨çš„è°ƒè¯•å·¥å…·ä¸­çœ‹åˆ°è¿™ä¸€ç‚¹ã€‚ä»¥ä¸‹æ˜¯[ç»´åŸºç™¾ç§‘](https://en.wikipedia.org/wiki/Call_stack?fbclid=IwAR06VWEQnwoEawg0NsoR8loBJwIbmPWsXXKqbAuOFBjkawHThK7zlIBsJ_U#Structure)çš„ä¸€äº›ç›¸å…³å¼•ç”¨å’Œå›¾è¡¨ï¼š

> åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œ**è°ƒç”¨æ ˆ**æ˜¯ä¸€ç§æ ˆæ•°æ®ç»“æ„ï¼Œå®ƒå­˜å‚¨æœ‰å…³è®¡ç®—æœºç¨‹åºçš„æ´»è·ƒå­ç¨‹åºçš„ä¿¡æ¯...è°ƒç”¨æ ˆå­˜åœ¨çš„ä¸»è¦åŸå› æ˜¯è·Ÿè¸ªæ¯ä¸ªæ´»è·ƒå­ç¨‹åºåœ¨å®Œæˆæ‰§è¡Œæ—¶åº”è¯¥è¿”å›æ§åˆ¶çš„ä½ç½®...è°ƒç”¨æ ˆç”±æ ˆå¸§ç»„æˆ...æ¯ä¸ªæ ˆå¸§å¯¹åº”äºä¸€ä¸ªå°šæœªç»ˆæ­¢è¿”å›çš„å­ä¾‹ç¨‹çš„è°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåä¸º`DrawSquare`çš„å­ç¨‹åºè°ƒç”¨ä¸€ä¸ªå½“å‰æ­£åœ¨è¿è¡Œçš„å­ç¨‹åº`DrawLine`ï¼Œåˆ™è°ƒç”¨æ ˆçš„é¡¶éƒ¨å¯èƒ½ä¼šåƒåœ¨ä¸‹é¢çš„å›¾ç‰‡ä¸­ä¸€æ ·ã€‚

![](../assets/images/1_WqEscsoRHItF0p4fZjHfsA.png)


#### ä¸ºä»€ä¹ˆæ ˆä¸Reactç›¸å…³ï¼Ÿ

æ­£å¦‚æˆ‘ä»¬åœ¨æœ¬æ–‡çš„ç¬¬ä¸€éƒ¨åˆ†ä¸­æ‰€å®šä¹‰çš„ï¼ŒReactåœ¨åè°ƒ/æ¸²æŸ“é˜¶æ®µéå†ç»„ä»¶æ ‘ï¼Œå¹¶ä¸ºç»„ä»¶æ‰§è¡Œä¸€äº›å·¥ä½œã€‚æ—§ç‰ˆæœ¬çš„åè°ƒå™¨ä½¿ç”¨ä¾èµ–äºå†…ç½®æ ˆç»“æ„çš„åŒæ­¥é€’å½’æ¨¡å‹æ¥éå†æ ‘ã€‚[åè°ƒçš„å®˜æ–¹æ–‡æ¡£](https://reactjs.org/docs/reconciliation.html#recursing-on-children)æè¿°äº†è¿™ä¸ªè¿‡ç¨‹ï¼Œå¹¶è°ˆäº†å¾ˆå¤šå…³äºé€’å½’çš„å†…å®¹ï¼š

> é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“å¯¹DOMèŠ‚ç‚¹çš„å­èŠ‚ç‚¹è¿›è¡Œé€’å½’æ—¶ï¼ŒReactä¼šåŒæ—¶è¿­ä»£ä¸¤ä¸ªå­èŠ‚ç‚¹åˆ—è¡¨ï¼Œå¹¶åœ¨å‡ºç°å·®å¼‚æ—¶ç”Ÿæˆçªå˜ï¼ˆmutationï¼‰ã€‚

å¦‚æœä½ è€ƒè™‘ä¸€ä¸‹ï¼Œ**æ¯ä¸ªé€’å½’è°ƒç”¨éƒ½ä¼šå‘æ ˆæ·»åŠ ä¸€ä¸ªå¸§ã€‚å¹¶ä¸”æ˜¯åŒæ­¥çš„**ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹ç»„ä»¶æ ‘ï¼š

![](../assets/images/1_TYWa1WAZ9iLip-rwBNPGEQ.png)


ç”¨`render`å‡½æ•°è¡¨ç¤ºä¸ºå¯¹è±¡ã€‚ä½ å¯ä»¥æŠŠå®ƒä»¬æƒ³è±¡æˆç»„ä»¶å®ä¾‹ï¼š

```js
const a1 = {name: 'a1'};
const b1 = {name: 'b1'};
const b2 = {name: 'b2'};
const b3 = {name: 'b3'};
const c1 = {name: 'c1'};
const c2 = {name: 'c2'};
const d1 = {name: 'd1'};
const d2 = {name: 'd2'};

a1.render = () => [b1, b2, b3];
b1.render = () => [];
b2.render = () => [c1];
b3.render = () => [c2];
c1.render = () => [d1, d2];
c2.render = () => [];
d1.render = () => [];
d2.render = () => [];
```

Reactéœ€è¦è¿­ä»£æ ‘å¹¶ä¸ºæ¯ä¸ªç»„ä»¶æ‰§è¡Œå·¥ä½œã€‚ä¸ºäº†ç®€åŒ–ï¼Œè¦åšçš„å·¥ä½œæ˜¯æ‰“å°å½“å‰ç»„ä»¶çš„åå­—å’Œè·å–å®ƒçš„childrenã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬å¦‚ä½•é€šè¿‡é€’å½’æ¥å®Œæˆå®ƒã€‚

#### é€’å½’éå†

å¾ªç¯éå†æ ‘çš„ä¸»è¦å‡½æ•°ç§°ä¸º`walk`ï¼Œå®ç°å¦‚ä¸‹ï¼š

```js
walk(a1);

function walk(instance) {
    doWork(instance);
    const children = instance.render();
    children.forEach(walk);
}

function doWork(o) {
    console.log(o.name);
}
```

è¿™é‡Œæ˜¯æˆ‘çš„å¾—åˆ°çš„è¾“å‡ºï¼š

`a1, b1, b2, c1, d1, d2, b3, c2
`

å¦‚æœä½ å¯¹é€’å½’ä¸ç†Ÿæ‚‰ï¼Œè¯·æŸ¥çœ‹[æˆ‘å…³äºé€’å½’çš„æ·±å…¥æ–‡ç« ](https://medium.freecodecamp.org/learn-recursion-in-10-minutes-e3262ac08a1)ã€‚

é€’å½’æ–¹æ³•ç›´è§‚ï¼Œéå¸¸é€‚åˆéå†æ ‘ã€‚ä½†æ˜¯æ­£å¦‚æˆ‘ä»¬å‘ç°çš„ï¼Œå®ƒæœ‰å±€é™æ€§ã€‚æœ€å¤§çš„ä¸€ç‚¹å°±æ˜¯æˆ‘ä»¬æ— æ³•åˆ†è§£å·¥ä½œä¸ºå¢é‡å•å…ƒã€‚æˆ‘ä»¬ä¸èƒ½æš‚åœç‰¹å®šç»„ä»¶çš„å·¥ä½œå¹¶åœ¨ç¨åæ¢å¤ã€‚é€šè¿‡è¿™ç§æ–¹æ³•ï¼ŒReactåªèƒ½ä¸æ–­è¿­ä»£ç›´åˆ°å®ƒå¤„ç†å®Œæ‰€æœ‰ç»„ä»¶ï¼Œå¹¶ä¸”æ ˆä¸ºç©ºã€‚

**é‚£ä¹ˆReactå¦‚ä½•å®ç°ç®—æ³•åœ¨æ²¡æœ‰é€’å½’çš„æƒ…å†µä¸‹éå†æ ‘ï¼Ÿå®ƒä½¿ç”¨å•é“¾è¡¨æ ‘éå†ç®—æ³•ã€‚å®ƒä½¿å¾—æš‚åœéå†å¹¶é˜»æ­¢æ ˆå¢é•¿æˆä¸ºå¯èƒ½ã€‚**

### é“¾è¡¨éå†

æˆ‘å¾ˆå¹¸è¿èƒ½æ‰¾åˆ°Sebastian MarkbÃ¥geåœ¨[è¿™é‡Œ](https://github.com/facebook/react/issues/7942#issue-182373497)æ¦‚è¿°çš„ç®—æ³•è¦ç‚¹ã€‚
è¦å®ç°è¯¥ç®—æ³•ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåŒ…å«3ä¸ªå­—æ®µçš„æ•°æ®ç»“æ„ï¼š

* child â€” ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹çš„å¼•ç”¨
* sibling â€” ç¬¬ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹çš„å¼•ç”¨
* return â€” çˆ¶èŠ‚ç‚¹çš„å¼•ç”¨

åœ¨Reactæ–°çš„åè°ƒç®—æ³•çš„ä¸Šä¸‹æ–‡ä¸­ï¼ŒåŒ…å«è¿™äº›å­—æ®µçš„æ•°æ®ç»“æ„ç§°ä¸ºFiberã€‚åœ¨åº•å±‚å®ƒæ˜¯ä¸€ä¸ªä»£è¡¨ä¿æŒå·¥ä½œé˜Ÿåˆ—çš„React Elementã€‚æ›´å¤šå†…å®¹è§æˆ‘çš„ä¸‹ä¸€ç¯‡æ–‡ç« ã€‚

ä¸‹å›¾å±•ç¤ºäº†é€šè¿‡é“¾è¡¨é“¾æ¥çš„å¯¹è±¡çš„å±‚çº§ç»“æ„å’Œå®ƒä»¬ä¹‹é—´çš„è¿æ¥ç±»å‹ï¼š

![](../assets/images/1_7dsyUaUpKbFG7EoNR9Cu2w.png)

æˆ‘ä»¬é¦–å…ˆå®šä¹‰æˆ‘ä»¬çš„è‡ªå®šä¹‰èŠ‚ç‚¹çš„æ„é€ å‡½æ•°ï¼š

```js
class Node {
    constructor(instance) {
        this.instance = instance;
        this.child = null;
        this.sibling = null;
        this.return = null;
    }
}
```

ä¸€ä¸ªä»¥èŠ‚ç‚¹æ•°ç»„ï¼ˆnodes[]ï¼‰ä¸ºå‚æ•°å¹¶å°†å®ƒä»¬é“¾æ¥åœ¨ä¸€èµ·çš„å‡½æ•°ã€‚æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥è·å–`render`æ–¹æ³•è¿”å›çš„å­èŠ‚ç‚¹ï¼š

```js
function link(parent, elements) {
    if (elements === null) elements = [];

    parent.child = elements.reduceRight((previous, current) => {
        const node = new Node(current);
        node.return = parent;
        node.sibling = previous;
        return node;
    }, null);

    return parent.child;
}
```

è¯¥å‡½æ•°ä»æœ€åä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹å¾€å‰éå†èŠ‚ç‚¹æ•°ç»„ï¼Œå°†å®ƒä»¬ç”¨ä¸€ä¸ªå•å‘é“¾è¡¨è¿æ¥èµ·æ¥ã€‚è¿”å›é“¾è¡¨ä¸­ç¬¬ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹çš„å¼•ç”¨ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•å·¥ä½œçš„ç®€å•æ¼”ç¤ºï¼š

```js
const children = [{name: 'b1'}, {name: 'b2'}];
const parent = new Node({name: 'a1'});
const child = link(parent, children);

// ä¸‹é¢ä¸¤è¡Œä»£ç çš„æ‰§è¡Œç»“æœä¸ºtrue
console.log(child.instance.name === 'b1');
console.log(child.sibling.instance === children[1]);
```

æˆ‘ä»¬è¿˜å°†å®ç°ä¸€ä¸ªç»™èŠ‚ç‚¹æ‰§è¡Œä¸€äº›å·¥ä½œçš„è¾…åŠ©å‡½æ•°ã€‚åœ¨æˆ‘ä»¬è¿™ä¸ªå‡½æ•°é‡Œï¼Œå®ƒå°†æ‰“å°ç»„ä»¶çš„åå­—ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜è¿”å›`å­`ç»„ä»¶èŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨ï¼š

```js
function doWork(node) {
    console.log(node.instance.name);
    const children = node.instance.render();
    return link(node, children);
}
```

å¥½çš„ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½å®ç°ä¸»è¦éå†ç®—æ³•äº†ã€‚è¿™æ˜¯çˆ¶èŠ‚ç‚¹ä¼˜å…ˆï¼Œæ·±åº¦ä¼˜å…ˆçš„ç®—æ³•å®ç°ã€‚ä»¥ä¸‹æ˜¯ä»£ç ï¼ˆåŒ…å«ä¸€äº›æœ‰ç”¨çš„æ³¨é‡Šï¼‰ï¼š

```js
function walk(o) {
    let root = o;
    let current = o;

    while (true) {
        // å¤„ç†èŠ‚ç‚¹ï¼Œå¹¶è·å–å­èŠ‚ç‚¹é“¾è¡¨
        let child = doWork(current);

        // å¦‚æœå­èŠ‚ç‚¹ä¸ä¸ºç©º, å°†å®ƒè®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹
        if (child) {
            current = child;
            continue;
        }

        // å¦‚æœæˆ‘ä»¬å›åˆ°äº†æ ¹èŠ‚ç‚¹ï¼Œé€€å‡ºå‡½æ•°
        if (current === root) {
            return;
        }

        // éå†ç›´åˆ°æˆ‘ä»¬å‘ç°å…„å¼ŸèŠ‚ç‚¹
        while (!current.sibling) {

            // å¦‚æœæˆ‘ä»¬å›åˆ°äº†æ ¹èŠ‚ç‚¹ï¼Œé€€å‡ºå‡½æ•°
            if (!current.return || current.return === root) {
                return;
            }

            // è®¾ç½®çˆ¶èŠ‚ç‚¹ä¸ºå½“å‰æ´»è·ƒèŠ‚ç‚¹
            current = current.return;
        }

        // å¦‚æœå‘ç°å…„å¼ŸèŠ‚ç‚¹ï¼Œè®¾ç½®å…„å¼ŸèŠ‚ç‚¹ä¸ºå½“å‰æ´»è·ƒèŠ‚ç‚¹
        current = current.sibling;
    }
}
```

è™½ç„¶ä»£ç å®ç°å¹¶ä¸æ˜¯ç‰¹åˆ«éš¾ä»¥ç†è§£ï¼Œä½†ä½ å¯èƒ½éœ€è¦ç¨å¾®è¿è¡Œä¸€ä¸‹ä»£ç æ‰èƒ½ç†è§£å®ƒã€‚[åœ¨è¿™é‡Œåš](https://stackblitz.com/edit/js-tle1wr)ã€‚
æ€è·¯æ˜¯ä¿æŒå¯¹å½“å‰èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œå¹¶åœ¨å‘ä¸‹éå†æ ‘æ—¶é‡æ–°ç»™å®ƒèµ‹å€¼ï¼Œç›´åˆ°æˆ‘ä»¬åˆ°è¾¾åˆ†æ”¯çš„æœ«å°¾ã€‚ç„¶åæˆ‘ä»¬ä½¿ç”¨`return`æŒ‡é’ˆè¿”å›æ ¹èŠ‚ç‚¹ã€‚

å¦‚æœæˆ‘ä»¬ç°åœ¨æ£€æŸ¥è¿™ä¸ªå®ç°çš„è°ƒç”¨æ ˆï¼Œä¸‹å›¾æ˜¯æˆ‘ä»¬å°†ä¼šçœ‹åˆ°çš„ï¼š

![](../assets/images/1_ybVgRoNf-dBxR_OKxn4oKQ.gif)

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œå½“æˆ‘ä»¬å‘ä¸‹éå†æ ‘æ—¶ï¼Œæ ˆä¸ä¼šå¢é•¿ã€‚ä½†å¦‚æœç°åœ¨æ”¾è°ƒè¯•å™¨åˆ°`doWork`å‡½æ•°å¹¶æ‰“å°èŠ‚ç‚¹åç§°ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ä¸‹å›¾ï¼š

![](https://img.alicdn.com/tfs/TB1e3oXyFYqK1RjSZLeXXbXppXa-320-240.gif)


**å®ƒçœ‹èµ·æ¥åƒæµè§ˆå™¨ä¸­çš„ä¸€ä¸ªè°ƒç”¨æ ˆã€‚**æ‰€ä»¥ä½¿ç”¨è¿™ä¸ªç®—æ³•ï¼Œæˆ‘ä»¬å°±æ˜¯ç”¨æˆ‘ä»¬çš„å®ç°æœ‰æ•ˆåœ°æ›¿æ¢æµè§ˆå™¨çš„è°ƒç”¨æ ˆçš„å®ç°ã€‚Andrewæ˜¯è¿™æ ·æè¿°çš„ï¼š

> Fiberæ˜¯æ ˆçš„é‡æ–°å®ç°ï¼Œä¸“é—¨ç”¨äºReactç»„ä»¶ã€‚ä½ å¯ä»¥å°†å•ä¸ªFiberè§†ä¸ºä¸€ä¸ªè™šæ‹Ÿæ ˆå¸§ã€‚

å› æ­¤æˆ‘ä»¬ç°åœ¨é€šè¿‡ä¿æŒå¯¹å……å½“é¡¶éƒ¨æ ˆå¸§çš„èŠ‚ç‚¹çš„å¼•ç”¨æ¥æ§åˆ¶æ ˆï¼š

```js
function walk(o) {
    let root = o;
    let current = o;

    while (true) {
            ...

            current = child;
            ...

            current = current.return;
            ...

            current = current.sibling;
    }
}
```

æˆ‘ä»¬å¯ä»¥éšæ—¶åœæ­¢éå†å¹¶ç¨åæ¢å¤ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦å®ç°çš„èƒ½å¤Ÿä½¿ç”¨æ–°çš„`requestIdleCallback` APIçš„æƒ…å†µã€‚

### Reactä¸­çš„å·¥ä½œå¾ªç¯

ä»¥ä¸‹[ä»£ç ](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L1118)å®ç°äº†Reactä¸­çš„å·¥ä½œå¾ªç¯ï¼š

```js
function workLoop(isYieldy) {
    if (!isYieldy) {
        // Flush work without yielding
        while (nextUnitOfWork !== null) {
            nextUnitOfWork = performUnitOfWork(nextUnitOfWork);
        }
    } else {
        // Flush asynchronous work until the deadline runs out of time.
        while (nextUnitOfWork !== null && !shouldYield()) {
            nextUnitOfWork = performUnitOfWork(nextUnitOfWork);
        }
    }
}
```

å¦‚ä½ æ‰€è§ï¼Œå®ƒå¾ˆå¥½åœ°æ˜ å°„åˆ°æˆ‘ä¸Šé¢æåˆ°çš„ç®—æ³•ã€‚`nextUnitOfWork`å˜é‡ä½œä¸ºé¡¶éƒ¨å¸§ï¼Œä¿ç•™å¯¹å½“å‰FiberèŠ‚ç‚¹çš„å¼•ç”¨ã€‚

è¯¥ç®—æ³•å¯ä»¥**åŒæ­¥åœ°**éå†ç»„ä»¶æ ‘ï¼Œå¹¶ä¸ºæ ‘ä¸­çš„æ¯ä¸ªFiberèŠ‚ç‚¹æ‰§è¡Œå·¥ä½œï¼ˆnextUnitOfWorkï¼‰ã€‚è¿™é€šå¸¸æ˜¯ç”±UIäº‹ä»¶ï¼ˆç‚¹å‡»ï¼Œè¾“å…¥ç­‰ï¼‰å¼•èµ·çš„æ‰€è°“äº¤äº’å¼æ›´æ–°ã€‚æˆ–è€…å®ƒå¯ä»¥**å¼‚æ­¥åœ°**éå†ç»„ä»¶æ ‘ï¼Œæ£€æŸ¥åœ¨æ‰§è¡ŒFiberèŠ‚ç‚¹å·¥ä½œåæ˜¯å¦è¿˜æœ‰å‰©ä½™çš„æ—¶é—´ã€‚
å‡½æ•°`shouldYield`è¿”å›[deadlineDidExpire](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L1806)å’Œ[deadline](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L1809)å˜é‡çš„ç»“æœï¼Œè¿™äº›å˜é‡åœ¨Reactä¸ºFiberèŠ‚ç‚¹æ‰§è¡Œå·¥ä½œæ—¶ä¸åœçš„æ›´æ–°ã€‚


[è¿™é‡Œ](https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e#1a7d)æ·±å…¥ä»‹ç»äº†`peformUnitOfWork`å‡½æ•°ã€‚

*****

#### æˆ‘æ­£åœ¨å†™ä¸€ç³»åˆ—æ·±å…¥æ¢è®¨Reactä¸­Fiberå˜åŒ–æ£€æµ‹ç®—æ³•å®ç°ç»†èŠ‚çš„æ–‡ç« ã€‚

### è¯·ç»§ç»­åœ¨[Twitter](https://twitter.com/maxim_koretskyi)å’Œ[Medium](https://medium.com/@maxim.koretskyi)ä¸Šå…³æ³¨æˆ‘ï¼Œæˆ‘ä¼šåœ¨æ–‡ç« å‡†å¤‡å¥½åç«‹å³å‘tweetã€‚

è°¢è°¢é˜…è¯»ï¼å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·ç‚¹å‡»ä¸‹é¢çš„ç‚¹èµæŒ‰é’®ğŸ‘ã€‚è¿™å¯¹æˆ‘æ¥è¯´æ„ä¹‰é‡å¤§ï¼Œå¹¶ä¸”å¯ä»¥å¸®åŠ©å…¶ä»–äººçœ‹åˆ°è¿™ç¯‡æ–‡ç« ã€‚