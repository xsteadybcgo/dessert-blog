**React Fiberå†…éƒ¨æ¦‚è¦**

ä¸ºäº†ç†è§£è¿™ç¯‡æ–‡ç« ä¸­æ‰€æè¿°çš„æ›´æ–°è¿‡ç¨‹çš„æŠ€æœ¯ç»†èŠ‚ï¼Œæˆ‘åœ¨ä¸Šä¸€ç¯‡æ–‡ç« [ã€ŠInside Fiber: æ·±å…¥è§£æReactä¸­çš„æ–°åè°ƒç®—æ³•ã€‹](https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e)é˜è¿°äº†å¿…å¤‡åŸºç¡€çŸ¥è¯†ã€‚

æˆ‘æ¦‚è¿°äº†è¿™ç¯‡æ–‡ç« ä¸­æåŠåˆ°çš„ä¸»è¦æ•°æ®ç»“æ„å’Œæ¦‚å¿µï¼Œå°¤å…¶æ˜¯fiberèŠ‚ç‚¹, current tree å’Œ work-in-progress tree, å‰¯ä½œç”¨å’Œå‰¯ä½œç”¨åˆ—è¡¨.æˆ‘è¿˜é«˜åº¦æ¦‚æ‹¬äº†ä¸»è¦ç®—æ³•ï¼Œè§£é‡Šäº†renderå’Œcommité˜¶æ®µçš„ä¸åŒç‚¹ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰é˜…è¯»é‚£ç¯‡æ–‡ç« ï¼Œæˆ‘å»ºè®®ä½ å…ˆé˜…è¯»äº†è§£ä¸€ä¸‹ã€‚

æˆ‘è¿˜å‘ä½ æ¼”ç¤ºäº†ä¸€ä¸ªæ‹¥æœ‰æŒ‰é’®çš„ç®€å•åº”ç”¨â€”â€”å¢åŠ æ•°å­—ç„¶åæ¸²æŸ“åœ¨å±å¹•ä¸Šï¼š

![](https://res.cloudinary.com/indepth-dev/image/upload/f_auto,fl_lossy,q_auto/local_media/2019/08/tmp4.mp4)

ä½ å¯ä»¥åœ¨[è¿™é‡Œ](https://stackblitz.com/edit/react-jwqn64)æ¼”ç¤ºä¸Šè¿°åº”ç”¨ï¼Œå®ƒç”±renderæ–¹æ³•è¿”å›çš„ä¸¤ä¸ªå­å…ƒç´ ï¼ˆ`button`å’Œ`span`ï¼‰æ„æˆï¼Œç»„ä»¶çš„çŠ¶æ€ç”±å†…éƒ¨å¥æŸ„æ›´æ–°ã€‚è¿™å¯¼è‡´äº†`span`å…ƒç´ æ–‡å­—å†…å®¹çš„æ›´æ–°ã€‚

```javascript
class ClickCounter extends React.Component {
    constructor(props) {
        super(props);
        this.state = {count: 0};
        this.handleClick = this.handleClick.bind(this);
    }

    handleClick() {
        this.setState((state) => {
            return {count: state.count + 1};
        });
    }
    
    componentDidUpdate() {}

    render() {
        return [
            <button key="1" onClick={this.handleClick}>Update counter</button>,
            <span key="2">{this.state.count}</span>
        ]
    }
}
```

æˆ‘è¿˜åœ¨ç»„ä»¶ä¸­æ·»åŠ äº†`componentDidUpdate`ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚è¿™ä¸ªç”¨æ¥æ¼”ç¤ºReactåœ¨commité˜¶æ®µæ˜¯å¦‚ä½•æ·»åŠ [å‰¯ä½œç”¨](https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e)å¹¶è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„ã€‚

è¿™ç¯‡æ–‡ç« æˆ‘æƒ³å‘ä½ é˜è¿°Reactå¦‚ä½•å¤„ç†stateæ›´æ–°å¹¶åˆ›å»ºå‰¯ä½œç”¨åˆ—è¡¨ã€‚æˆ‘å°†æ¢ç´¢`render`é˜¶æ®µå’Œ`commit`é˜¶æ®µçš„é«˜å±‚çº§å‡½æ•°ä¸­å‘ç”Ÿäº†ä»€ä¹ˆã€‚

ç‰¹åˆ«æ˜¯åœ¨React [completeWork](https://github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberCompleteWork.js#L532) å‡½æ•°ä¸­å¦‚ä½•å·¥ä½œï¼š
- æ›´æ–°ClickCounterç»„ä»¶çŠ¶æ€çš„countå±æ€§
- è°ƒç”¨_render_æ–¹æ³•æ¥å¾—åˆ°å­ç»„ä»¶åˆ—è¡¨å¹¶è¿›è¡Œæ¯”è¾ƒ
- æ›´æ–°spanå…ƒç´ çš„_props_

åœ¨React [commitRoot](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L523)ä¸­ï¼š
- updates the textContent property of the span element
- æ›´æ–°spanå…ƒç´ çš„æ–‡å­—å†…å®¹
- è°ƒç”¨_componentDidUpdate_ç”Ÿå‘½å‘¨æœŸå‡½æ•°

é¦–å…ˆï¼Œè®©æˆ‘ä»¬å¿«é€Ÿæµè§ˆä¸€ä¸‹å½“åœ¨ç‚¹å‡»äº‹ä»¶ä¸­è°ƒç”¨setStateï¼Œworkæ˜¯å¦‚ä½•è°ƒåº¦çš„ã€‚

**æ³¨æ„åœ¨ä½¿ç”¨reactçš„è¿‡ç¨‹ä¸­ä½ æ— éœ€çŸ¥é“è¿™äº›äº‹æƒ…ã€‚è¿™ç¯‡æ–‡ç« æ˜¯å…³äºReactå†…éƒ¨å¦‚ä½•å·¥ä½œçš„ä»‹ç»ã€‚**

##è°ƒåº¦æ›´æ–°
When we click on the button, the click event is triggered and React executes the callback that we pass in the button props. In our application it simply increments the counter and updates the state:
å½“æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œç‚¹å‡»äº‹ä»¶è¢«è§¦å‘ï¼ŒReactæ‰§è¡Œæˆ‘ä»¬é€šè¿‡button propsä¼ é€’çš„å›è°ƒå‡½æ•°ã€‚åœ¨æˆ‘ä»¬çš„åº”ç”¨ä¸­ï¼Œå°±æ˜¯ç®€å•çš„å¢åŠ counterï¼Œæ›´æ–°stateï¼š

```javascript
class ClickCounter extends React.Component {
    ...
    handleClick() {
        this.setState((state) => {
            return {count: state.count + 1};
        });
    }
}
```

æ¯ä¸€ä¸ªReactç»„ä»¶éƒ½æœ‰ä¸€ä¸ªåœ¨ç»„ä»¶å’ŒReact coreä¸­é—´æ‰®æ¼”æ¡¥çš„å…³è”æ›´æ–°ã€‚è¿™å…è®¸setStateå¯ä»¥è¢«ReactDOM, React Native,ssrå’Œå•å…ƒæµ‹è¯•ä»¥ä¸åŒçš„æ–¹å¼å®ç°.

è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°†æ¢è®¨ReactDOMä¸­æ›´æ–°å¯¹è±¡çš„å®ç°ï¼Œè¿™ä¸ªå®ç°ä½¿ç”¨äº†Fiberåè°ƒæœºåˆ¶ã€‚ClickCounterç»„ä»¶æ˜¯ä¸€ä¸ªclassç»„ä»¶æ›´æ–°ã€‚å®ƒè´Ÿè´£Fiberå®ä¾‹å–å›ã€é˜Ÿåˆ—æ›´æ–°å’Œå·¥ä½œè°ƒåº¦

å½“æ›´æ–°åœ¨æ’é˜Ÿæ—¶ï¼Œä»–ä»¬åªæ˜¯è¢«æ·»åŠ åˆ°æ›´æ–°é˜Ÿåˆ—ä¸­æ¥å¤„ç†FiberèŠ‚ç‚¹ã€‚åœ¨æˆ‘ä»¬å½“æ¡ˆä¾‹ä¸­ï¼ŒClickCounterè¡ç”Ÿçš„FiberèŠ‚ç‚¹æœ‰å¦‚ä¸‹ç»“æ„ï¼š
```javascript
{
    stateNode: new ClickCounter,
    type: ClickCounter,
    updateQueue: {
         baseState: {count: 0}
         firstUpdate: {
             next: {
                 payload: (state) => { return {count: state.count + 1} }
             }
         },
         ...
     },
     ...
}
```
å¦‚ä½ æ‰€è§ï¼Œ `updateQueue.firstUpdate.next.payload`ä¸­çš„å‡½æ•°å°±æ˜¯æˆ‘ä»¬åœ¨ClickCounterç»„ä»¶ä¸­ä¼ é€’ç»™setStateçš„å›è°ƒã€‚å®ƒä»£è¡¨äº†åœ¨renderé˜¶æ®µé¦–å…ˆéœ€è¦è¢«å¤„ç†çš„æ›´æ–°ã€‚

## ä¸ºClickCounter FiberèŠ‚ç‚¹å¤„ç†æ›´æ–°
åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­çš„[å·¥ä½œå¾ªç¯ç« èŠ‚](https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e)ï¼Œè§£é‡Šäº†`nextUnitOfWork`å…¨å±€å˜é‡çš„è§’è‰²ã€‚å°¤å…¶æ˜¯åœ¨æ–‡ç« ä¸­é™ˆè¿°äº†è¿™ä¸ªå˜é‡æŒæœ‰workInProgressä¸­çš„FiberèŠ‚ç‚¹çš„å¼•ç”¨ï¼Œè¯¥èŠ‚ç‚¹æœ‰ä¸€äº›éœ€è¦å¤„ç†çš„å·¥ä½œã€‚åœ¨Reactéå†Fiberæ ‘æ—¶ï¼Œå®ƒä½¿ç”¨è¿™ä¸ªå˜é‡æ¥çœ‹æ˜¯å¦æœ‰å…¶ä»–æœªå®Œæˆå¤„ç†çš„FiberèŠ‚ç‚¹ã€‚

é¦–å…ˆæˆ‘ä»¬å‡è®¾`setState`æ–¹æ³•è¢«è°ƒç”¨ã€‚Reactå°†**`setState`**ä¸­çš„å›è°ƒå‡½æ•°æ·»åŠ åˆ°`ClickCounter`fiberèŠ‚ç‚¹çš„`updateQueue`ä¸­å¹¶è°ƒåº¦workã€‚Reactè¿›å…¥`render`é˜¶æ®µã€‚å®ƒä½¿ç”¨[renderRoot](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L1132)å‡½æ•°å¼€å§‹ä»æœ€é¡¶å±‚çš„`HostRoot` FiberèŠ‚ç‚¹å¼€å§‹éå†ã€‚å®ƒä¼šè·³è¿‡å·²å¤„ç†è¿‡çš„FiberèŠ‚ç‚¹ï¼Œç›´åˆ°å®ƒæ‰¾åˆ°æœªå®Œæˆå¤„ç†çš„FiberèŠ‚ç‚¹ä¸ºæ­¢ã€‚è‡³æ­¤åªæœ‰`ClickCounter`è¿™ä¸€ä¸ªFiberèŠ‚ç‚¹æœ‰ä¸€äº›workéœ€è¦å¤„ç†ã€‚

æ‰€æœ‰çš„å¤„ç†éƒ½æ˜¯åœ¨è¿™ä¸ªFiberèŠ‚ç‚¹çš„å‰¯æœ¬ä¸Šè¿›è¡Œçš„ï¼Œå®ƒä¿å­˜åœ¨`alternate` å­—æ®µä¸Šã€‚å¦‚æœ`alternate`èŠ‚ç‚¹è¿˜æœªåˆ›å»ºï¼ŒReactåœ¨å¤„ç†æ›´æ–°å‰ï¼Œä¼šåœ¨[createWorkInProgress](https://github.com/facebook/react/blob/769b1f270e1251d9dbdce0fcbd9e92e502d059b8/packages/react-reconciler/src/ReactFiber.js#L326)å‡½æ•°ä¸­åˆ›å»ºå…¶å‰¯æœ¬ã€‚æˆ‘ä»¬å‡è®¾`nextUnitOfWork`å˜é‡ä¿ç•™äº†ä¸€ä»½`ClickCounter` FiberèŠ‚ç‚¹çš„å¼•ç”¨ã€‚

## beginWork

é¦–å…ˆæˆ‘ä»¬çš„Fiberè¿›å…¥`beginWork`å‡½æ•°ã€‚
>ç”±äºè¿™ä¸ªå‡½æ•°åœ¨æ¯ä¸€ä¸ªFiberèŠ‚ç‚¹å¤„ç†è¿‡ç¨‹ä¸­éƒ½ä¼šæ‰§è¡Œï¼Œå› æ­¤å¦‚æœä½ æƒ³debug`render`é˜¶æ®µï¼Œè¯¥å‡½æ•°æ˜¯ä¸€ä¸ªæ‰“æ–­ç‚¹çš„å¥½åœ°æ–¹ã€‚æˆ‘ç»å¸¸è¿™ä¹ˆåšï¼Œä»¥æ­¤æ¥æ£€æŸ¥æˆ‘æƒ³ææ¸…æ¥šçš„é‚£ä¸ªFiberèŠ‚ç‚¹çš„ç±»å‹ã€‚

`beginWork`å‡½æ•°åŸºæœ¬ä¸Šå¯ä»¥å½“ä½œä¸€ä¸ªå¤§å¤§çš„`switch`è¯­å¥ï¼Œå®ƒæ ¹æ®FiberèŠ‚ç‚¹çš„tagä½œä¸ºåˆ¤æ–­ä¾æ®ï¼Œæ¥å†³å®šå…¶éœ€è¦è¢«å¤„ç†çš„ä»»åŠ¡ç±»å‹ï¼Œç„¶åæ‰§è¡Œå„è‡ªå‡½æ•°æ¥å¤„ç†ç›¸åº”ä»»åŠ¡ã€‚åœ¨`CountClicks`è¿™ä¸ªä¾‹å­ä¸­ï¼Œå®ƒæ˜¯ä¸€ä¸ªclassç»„ä»¶ï¼Œæ‰€ä»¥æ‰§è¡Œä»¥ä¸‹åˆ†æ”¯ï¼š
```javascript
function beginWork(current$$1, workInProgress, ...) {
    ...
    switch (workInProgress.tag) {
        ...
        case FunctionalComponent: {...}
        case ClassComponent:
        {
            ...
            return updateClassComponent(current$$1, workInProgress, ...);
        }
        case HostComponent: {...}
        case ...
}
```

æˆ‘ä»¬è¿›å…¥[updateClassComponent](https://github.com/facebook/react/blob/1034e26fe5e42ba07492a736da7bdf5bf2108bc6/packages/react-reconciler/src/ReactFiberBeginWork.js#L428) å‡½æ•°ã€‚ä¾æ®æ˜¯å¦ä¸ºé¦–æ¬¡æ¸²æŸ“ã€å¤ç”¨å¤„ç†ã€è¿˜æ˜¯ä¸€ä¸ªReactæ›´æ–°ï¼ŒReactè¦ä¹ˆåˆ›å»ºä¸€ä¸ªå®ä¾‹å¹¶æŒ‚åœ¨ç»„ä»¶ï¼Œè¦ä¹ˆåªæ˜¯æ›´æ–°å®ƒï¼š

```javascript
function updateClassComponent(current, workInProgress, Component, ...) {
    ...
    const instance = workInProgress.stateNode;
    let shouldUpdate;
    if (instance === null) {
        ...
        // In the initial pass we might need to construct the instance.
        constructClassInstance(workInProgress, Component, ...);
        mountClassInstance(workInProgress, Component, ...);
        shouldUpdate = true;
    } else if (current === null) {
        // In a resume, we'll already have an instance we can reuse.
        shouldUpdate = resumeMountClassInstance(workInProgress, Component, ...);
    } else {
        shouldUpdate = updateClassInstance(current, workInProgress, ...);
    }
    return finishClassComponent(current, workInProgress, Component, shouldUpdate, ...);
}

```
## ä¸ºClickCounter Fiberå¤„ç†æ›´æ–°
æˆ‘ä»¬å·²ç»æœ‰äº†`ClickCounter`ç»„ä»¶å®ä¾‹ï¼Œæˆ‘ä»¬æ¥è¿›å…¥åˆ°`updateClassInstance`ã€‚è¿™é‡Œæ˜¯Reactå¤„ç†classç»„ä»¶ç»å¤§éƒ¨åˆ†å·¥ä½œçš„åœ°æ–¹ã€‚ä»¥ä¸‹ä»£ç æ˜¯è¯¥å‡½æ•°ä¸­å¤§éƒ¨åˆ†çš„é‡è¦æ“ä½œï¼ŒæŒ‰ç…§æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š

- call UNSAFE_componentWillReceiveProps() hook (deprecated)

- è°ƒç”¨`UNSAFE_componentWillReceiveProps()`é’©å­ï¼ˆ<s>åºŸå¼ƒ</s>ï¼‰

- å¤„ç†`updateQueue`ä¸­çš„æ›´æ–°å¹¶ç”Ÿæˆæ–°çš„`state`

- ä½¿ç”¨æ–°çš„`state`ä½œä¸ºå‚æ•°è°ƒç”¨`getDerivedStateFromProps`å¹¶æ‹¿åˆ°å…¶ç»“æœ

- è°ƒç”¨`shouldComponentUpdate`æ¥ç¡®è®¤ç»„ä»¶æ˜¯å¦éœ€è¦æ›´æ–°ï¼›å¦‚æœä¸º`false`ï¼Œè·³è¿‡æ•´ä¸ªæ¸²æŸ“å¤„ç†â€”â€”å…¶ä¸­åŒ…æ‹¬è°ƒç”¨è¯¥ç»„ä»¶åŠå…¶å­ç»„ä»¶çš„`render`æ–¹æ³•ï¼›å¦åˆ™å¤„ç†æ›´æ–°

- è°ƒç”¨`UNSAFE_componentWillUpdate` (<s>åºŸå¼ƒ</s>)

- æ·»åŠ å‰¯ä½œç”¨æ¥è§¦å‘`componentDidUpdate`ç”Ÿå‘½å‘¨æœŸé’©å­
> è™½ç„¶è°ƒç”¨`componentDidUpdate`çš„å‰¯ä½œç”¨æ˜¯åœ¨`render`é˜¶æ®µæ·»åŠ çš„ï¼Œä½†æ˜¯è¯¥æ–¹æ³•ä¼šåœ¨æ¥ä¸‹æ¥çš„`commit`é˜¶æ®µæ‰§è¡Œã€‚  

- æ›´æ–°ç»„ä»¶å®ä¾‹çš„`state`å’Œ`props`

`state`å’Œ`props`åº”è¯¥åœ¨è°ƒç”¨`render`æ–¹æ³•å‰æ›´æ–°ï¼Œå› ä¸º`render`æ–¹æ³•çš„è¿”å›ç»“æœå¾€å¾€ä¾èµ–äº`state`å’Œ`props`ã€‚å¦‚æœæˆ‘ä»¬ä¸è¿™ä¹ˆåšï¼Œå®ƒï¼ˆ`render`ï¼‰å°†æ€»æ˜¯è¿”å›ç›¸åŒçš„ç»“æœã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªç®€ç‰ˆçš„ï¼ˆæ›´æ–°ï¼‰å‡½æ•°ï¼š

```javascript
function updateClassInstance(current, workInProgress, ctor, newProps, ...) {
    const instance = workInProgress.stateNode;

    const oldProps = workInProgress.memoizedProps;
    instance.props = oldProps;
    if (oldProps !== newProps) {
        callComponentWillReceiveProps(workInProgress, instance, newProps, ...);
    }

    let updateQueue = workInProgress.updateQueue;
    if (updateQueue !== null) {
        processUpdateQueue(workInProgress, updateQueue, ...);
        newState = workInProgress.memoizedState;
    }

    applyDerivedStateFromProps(workInProgress, ...);
    newState = workInProgress.memoizedState;

    const shouldUpdate = checkShouldComponentUpdate(workInProgress, ctor, ...);
    if (shouldUpdate) {
        instance.componentWillUpdate(newProps, newState, nextContext);
        workInProgress.effectTag |= Update;
        workInProgress.effectTag |= Snapshot;
    }

    instance.props = newProps;
    instance.state = newState;

    return shouldUpdate;
}
```

åœ¨ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œæˆ‘ç§»é™¤äº†ä¸€äº›è¾…åŠ©æ€§çš„ä»£ç ã€‚ä¾‹å¦‚ï¼Œåœ¨è°ƒç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¹‹å‰ï¼Œæˆ–è€…åœ¨æ·»åŠ ç”¨äºè§¦å‘ä»–ä»¬ï¼ˆlifecycleï¼‰çš„å‰¯ä½œç”¨ä¹‹å‰ï¼ŒReactä¼šä½¿ç”¨`typeof`æ“ä½œç¬¦æ¥æ£€æµ‹ç»„ä»¶æ˜¯å¦å®ç°äº†è¿™ä¸ªæ–¹æ³•ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬æ¥ä¸¾ä¸ªğŸŒ°ï¼ŒReactåœ¨æ·»åŠ å‰¯ä½œç”¨å‰æ˜¯å¦‚ä½•æ£€æŸ¥`componentDidUpdate`æ–¹æ³•çš„ï¼š

```javascript
if (typeof instance.componentDidUpdate === 'function') {
    workInProgress.effectTag |= Update;
}
```
å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬çŸ¥é“äº†åœ¨`render`é˜¶æ®µï¼Œæœ‰å“ªäº›æ“ä½œæ˜¯ä½œç”¨åœ¨`ClickCounter`FiberèŠ‚ç‚¹ä¸Šçš„ã€‚è®©æˆ‘ä»¬çœ‹çœ‹è¿™äº›æ“ä½œæ˜¯å¦‚ä½•æ”¹å˜FiberèŠ‚ç‚¹ä¸Šçš„å€¼çš„ã€‚å½“Reactå¼€å§‹å·¥ä½œæ—¶ï¼Œ`ClickCounter`ç»„ä»¶å¯¹åº”çš„FiberèŠ‚ç‚¹çœ‹ä¸Šå»åƒè¿™æ ·ğŸ‘‡ï¼š
```javascript
{
    effectTag: 0,
    elementType: class ClickCounter,
    firstEffect: null,
    memoizedState: {count: 0},
    type: class ClickCounter,
    stateNode: {
        state: {count: 0}
    },
    updateQueue: {
        baseState: {count: 0},
        firstUpdate: {
            next: {
                payload: (state, props) => {â€¦}
            }
        },
        ...
    }
}
```
åœ¨å·¥ä½œå®Œæˆåï¼Œæˆ‘ä»¬å¤„ç†å®Œçš„FiberèŠ‚ç‚¹çœ‹ä¸Šå»åƒè¿™æ ·ğŸ‘‡ï¼š
```javascript
{
    effectTag: 4,
    elementType: class ClickCounter,
    firstEffect: null,
    memoizedState: {count: 1},
    type: class ClickCounter,
    stateNode: {
        state: {count: 1}
    },
    updateQueue: {
        baseState: {count: 1},
        firstUpdate: null,
        ...
    }
}
```
**èŠ±ç‚¹æ—¶é—´è§‚å¯Ÿä¸€ä¸‹ï¼ˆä¸Šè¿°ï¼‰å±æ€§å€¼çš„ä¸åŒç‚¹**

æ›´æ–°åï¼Œ`memoizedState`å’Œ`updateQueue.updateQueue`ä¸­çš„`count`å±æ€§å˜ä¸ºäº†`1`ã€‚Reactè¿˜æ›´æ–°äº†`ClickCounter`ç»„ä»¶å®ä¾‹çš„`state`


æ­¤æ—¶ï¼Œé˜Ÿåˆ—ä¸­ä¸åœ¨æŒæœ‰æ›´æ–°ï¼Œå› æ­¤`firstUpdate`çš„å€¼ä¸º`null`ã€‚é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬çš„`effectTag`å±æ€§å€¼æ”¹å˜äº†ã€‚ä»–ä¸å†æ˜¯`0`,å…¶çš„å€¼ä¸º`4`ã€‚åœ¨äºŒè¿›åˆ¶ä¸­è¡¨ç¤ºä¸º`100`ï¼Œè¿™æ„å‘³ç€å…¶ç¬¬ä¸‰ä¸ªæ¯”ç‰¹ä½è¢«è®¾ç½®ï¼Œè¯¥æ¯”ç‰¹ä½ä»£è¡¨`Update`[side-effect tag](https://github.com/facebook/react/blob/b87aabdfe1b7461e7331abb3601d9e6bb27544bc/packages/shared/ReactSideEffectTags.js)

```javascript
export const Update = 0b00000000100;
```

æ€»ç»“ä¸€ä¸‹ï¼Œåœ¨å¤„ç†çˆ¶çº§`ClickCounter`FiberèŠ‚ç‚¹æ—¶ï¼ŒReactè°ƒç”¨é¢„å˜æ›´çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œæ›´æ–°stateå¹¶åˆ¤æ–­ç›¸å…³å‰¯ä½œç”¨ã€‚

ä¸€æ—¦å®Œæˆï¼ŒReactè¿›å…¥[finishClassComponent](https://github.com/facebook/react/blob/340bfd9393e8173adca5380e6587e1ea1a23cefa/packages/react-reconciler/src/ReactFiberBeginWork.js#L355)ï¼Œè¿™ä¸ªå‡½æ•°ä¸­Reactè°ƒç”¨äº†ç»„ä»¶å®ä¾‹çš„`render`æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨å…¶è¿”å›å¯¹å­ç»„ä»¶ä¸Šåº”ç”¨diffç®—æ³•ã€‚[è¿™è¾¹æ–‡ç« ä¸­](https://reactjs.org/docs/reconciliation.html#the-diffing-algorithm)å¯¹å…¶è¿›è¡Œäº†å®è§‚æè¿°ã€‚ä»¥ä¸‹æ˜¯ç›¸å…³éƒ¨åˆ†ï¼š

>å½“æ¯”è¾ƒä¸¤ä¸ªç›¸åŒç±»å‹çš„React DOMå…ƒç´ æ—¶ï¼ŒReactæ£€æŸ¥ä¸¤è€…å±æ€§ï¼Œä¿ç•™ç›¸åŒçš„åº•å±‚DOMèŠ‚ç‚¹ï¼Œåªæ›´æ–°å·²æ”¹å˜å¯¹å±æ€§ã€‚

å¦‚æœæˆ‘ä»¬æ·±åº¦å‰–æï¼Œæˆ‘ä»¬ä¼šå‘ç°å®ƒå®é™…ä¸Šæ˜¯å¯¹æ¯”Reactå…ƒç´ çš„FiberèŠ‚ç‚¹ã€‚ç”±äºè¯¥è¿‡ç¨‹éå¸¸ç¹çæˆ‘ä»¬ä¸ä¼šæ·±å…¥å¤ªå¤šç»†èŠ‚ã€‚æˆ‘å°†å•ç‹¬å¦å†™ä¸€ç¯‡å•æ¥ä»‹ç»å­åè°ƒçš„å¤„ç†è¿‡ç¨‹

>å¦‚æœä½ å¯¹ç»†èŠ‚éå¸¸æ„Ÿå…´è¶£ï¼Œä½ å¯ä»¥çœ‹çœ‹[reconcileChildrenArray](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactChildFiber.js#L732)å‡½æ•°ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬è¿™ä¸ªåº”ç”¨ä¸­`render`æ–¹æ³•è¿”å›äº†React Elementæ•°ç»„ã€‚

ç°åœ¨æœ‰ä¸¤ç‚¹éå¸¸é‡è¦çš„äº‹æƒ…éœ€è¦ç†è§£ã€‚**é¦–å…ˆ**ï¼Œéšç€Reactè¿›è¡Œå­åè°ƒè¿‡ç¨‹ï¼Œ**å®ƒåˆ›å»ºå¹¶æ›´æ–°Reactå­å…ƒç´ å¯¹åº”çš„Fiber Node**ï¼Œè¿™äº›èŠ‚ç‚¹ç”±`render`æ–¹æ³•è¿”å›ã€‚`finishClassComponent`å‡½æ•°è¿”å›current FiberèŠ‚ç‚¹ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹çš„å¼•ç”¨ã€‚å®ƒä¼šè¢«åˆ†é…ç»™`nextUnitOfWork`å¹¶ç¨ååœ¨å·¥ä½œå¾ªç¯ä¸­å¤„ç†ã€‚**å…¶æ¬¡**ï¼ŒReactå°†**æ›´æ–°å­èŠ‚ç‚¹çš„props**ä½œä¸ºçˆ¶èŠ‚ç‚¹äº‹åŠ¡å¤„ç†çš„ä¸€éƒ¨åˆ†ã€‚ä¸ºè¾¾ç›®çš„ï¼Œä½¿ç”¨`render`æ–¹æ³•è¿”å›çš„Reactå…ƒç´ ä¸­çš„æ•°æ®ã€‚


ä¾‹å¦‚ï¼Œåœ¨Reactåè°ƒ`ClickCounter` fiberçš„å­èŠ‚ç‚¹å‰ï¼Œæœ‰ä¸€ä¸ª`span`å…ƒç´ å¯¹åº”çš„FiberèŠ‚ç‚¹é•¿è¿™æ ·ï¼š
```javascript
{
    stateNode: new HTMLSpanElement,
    type: "span",
    key: "2",
    memoizedProps: {children: 0},
    pendingProps: {children: 0},
    ...
}
```

å¦‚ä½ æ‰€è§ï¼Œ` memoizedProps`å’Œ`pendingProps`ä¸­çš„`children`å±æ€§éƒ½æ˜¯`0`ã€‚ä¸‹é¢æ˜¯`span`å…ƒç´ ä¸­`render`æ–¹æ³•è¿”å›çš„Reactå…ƒç´ çš„æ•°æ®ç»“æ„ï¼š
```javascript
{
    $$typeof: Symbol(react.element)
    key: "2"
    props: {children: 1}
    ref: null
    type: "span"
}
```

å¦‚ä½ æ‰€è§ï¼ŒFiberèŠ‚ç‚¹å’Œè¿”å›çš„Reactå…ƒç´ ä¸Š**propsæœ‰ä¸€äº›å·®å¼‚**ã€‚åœ¨å†…éƒ¨`createWorkInProgress`å‡½æ•°ç”¨äºåˆ›å»º alternate(_äº¤æ›¿çš„_) FiberèŠ‚ç‚¹ï¼Œ**Reactå°†ä¼šæŠŠReactå…ƒç´ ä¸Šæ›´æ–°çš„å±æ€§å¤åˆ¶åˆ°FiberèŠ‚ç‚¹ä¸Šå»**ã€‚

å› æ­¤ï¼Œåœ¨Reactå®Œæˆ`ClickCounter`ç»„ä»¶çš„å­åè°ƒåï¼Œ`span`FiberèŠ‚ç‚¹å°†æ›´æ–°`pendingProps`ã€‚ä»–ä»¬å°†åŒ¹é…`span`React å…ƒç´ çš„å€¼ã€‚

```javascript
{
    stateNode: new HTMLSpanElement,
    type: "span",
    key: "2",
    memoizedProps: {children: 0},
    pendingProps: {children: 1},
    ...
}
```

ä¹‹åï¼Œå½“Reactå°†è¦å¯¹`span`FiberèŠ‚ç‚¹è¿›è¡Œå¤„ç†æ—¶ï¼ŒReactä¼šå°†ä»–ä»¬å¤åˆ¶åˆ°`memoizedProps`ä¸Šï¼Œå¹¶ä¸”æ·»åŠ å‰¯ä½œç”¨ä»¥æ›´æ–°DOMã€‚

å¥½äº†ï¼Œä»¥ä¸Šå°±æ˜¯åœ¨renderé˜¶æ®µï¼ŒReactå¯¹`ClickCounter`fiberèŠ‚ç‚¹æ‰€åšå¯¹æ‰€æœ‰äº‹æƒ…ã€‚ç”±äº`button`æ˜¯`ClickCounter`ç»„ä»¶çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå®ƒå°†è¢«åˆ†é…ç»™`nextUnitOfWork`å˜é‡ã€‚Reactå¯¹è¯¥èŠ‚ç‚¹æ²¡æœ‰ä»€ä¹ˆè¦å¤„ç†çš„ï¼Œå› æ­¤Reactå°†ç§»æ­¥åˆ°å®ƒçš„ç›¸é‚»èŠ‚ç‚¹--`span` FiberèŠ‚ç‚¹ä¸Šã€‚æ ¹æ®è¿™é‡Œæè¿°çš„[ç®—æ³•](https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e)ï¼Œè¿™å‘ç”Ÿåœ¨`completeUnitOfWork`å‡½æ•°ä¸­ã€‚

## å¤„ç† Span fiberçš„æ›´æ–°

å—¯ï½ `nextUnitOfWork`å˜é‡ç°åœ¨æŒ‡å‘`span` **alternate** fiberï¼ŒReactå¼€å§‹å¯¹å®ƒè¿›è¡Œå¤„ç†ã€‚å’Œå¤„ç†`ClickCounter`ç›¸ä¼¼ï¼Œæˆ‘ä»¬ä»[beginWork](https://github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberBeginWork.js#L1489)å‡½æ•°å¼€å§‹ã€‚

å› ä¸ºæˆ‘ä»¬çš„`span`èŠ‚ç‚¹æ˜¯`HostComponent`ç±»å‹ï¼Œåœ¨switchè¯­å¥ä¸­Reactèµ°ä»¥ä¸‹ä»£ç åˆ†æ”¯:
```javascript
function beginWork(current$$1, workInProgress, ...) {
    ...
    switch (workInProgress.tag) {
        case FunctionalComponent: {...}
        case ClassComponent: {...}
        case HostComponent:
          return updateHostComponent(current, workInProgress, ...);
        case ...
}
```

åœ¨[updateHostComponent](https://github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberBeginWork.js#L686)å‡½æ•°ç»“æŸåã€‚ä½ ä¼šå‘ç°æœ‰ä¸€ä¸ªå¹¶è¡Œåœ°ä¸ºclassç±»å‹ç»„ä»¶è°ƒç”¨çš„`updateClassComponent`å‡½æ•°ã€‚å¯¹äºå‡½æ•°ç»„ä»¶å®ƒå°†æ˜¯`updateFunctionComponent`å‡½æ•°è°ƒç”¨ï¼Œä½ å¯ä»¥åœ¨[ReactFiberBeginWork.js](ReactFiberBeginWork.js)æ–‡ä»¶ä¸­æ‰¾åˆ°è¿™äº›å‡½æ•°ã€‚

## ä¸ºspan fiberå­å…ƒç´ åšåè°ƒå¤„ç†

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œ`span`èŠ‚ç‚¹æ²¡æœ‰é‡è¦çš„ä¸œè¥¿è¦å¤„ç†ã€‚

##ä¸ºSpan FiberèŠ‚ç‚¹å®Œæˆå·¥ä½œ

ä¸€æ—¦`beginWork`ç»“æŸï¼ŒèŠ‚ç‚¹å°±è¿›å…¥`completeWork`å‡½æ•°ã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼ŒReactéœ€è¦æ›´æ–°`span`fiberä¸Šçš„`memoizedProps`ã€‚ä½ å¯èƒ½ä¼šè®°å¾—å½“åè°ƒå¤„ç†ClickCounterç»„ä»¶çš„å­èŠ‚ç‚¹æ—¶ï¼ŒReactæ›´æ–°äº†`span`FiberèŠ‚ç‚¹çš„`pendingProps`ï¼š

```javascript
{
    stateNode: new HTMLSpanElement,
    type: "span",
    key: "2",
    memoizedProps: {children: 0},
    pendingProps: {children: 1},
    ...
}
```

ä¸€æ—¦`span`fiberçš„`beginWork`æ‰§è¡Œå®Œæ¯•ï¼ŒReactæ›´æ–°`pendingProps`æ¥åŒ¹é…`memoizedProps`:

```javascript
function performUnitOfWork(workInProgress) {
    ...
    next = beginWork(current$$1, workInProgress, nextRenderExpirationTime);
    workInProgress.memoizedProps = workInProgress.pendingProps;
    ...
}
```

ç„¶åè°ƒç”¨`completeWork`å‡½æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªåºå¤§çš„`switch`å£°æ˜è¯­å¥ï¼Œå¦‚åŒæˆ‘ä»¬åœ¨å‰é¢çœ‹åˆ°çš„`beginWork`ä¸€æ ·ï¼š

```javascript
function completeWork(current, workInProgress, ...) {
    ...
    switch (workInProgress.tag) {
        case FunctionComponent: {...}
        case ClassComponent: {...}
        case HostComponent: {
            ...
            updateHostComponent(current, workInProgress, ...);
        }
        case ...
    }
}
```

å› ä¸ºæˆ‘ä»¬çš„`span`FiberèŠ‚ç‚¹æ˜¯`HostComponent`,å®ƒè¿è¡Œ[updateHostComponent](https://github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberBeginWork.js#L686)å‡½æ•°ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­Reactåšä»¥ä¸‹äº‹æƒ…ï¼š
- ä¸ºDOMæ›´æ–°ä½œå‡†å¤‡
- å°†ä»–ä»¬æ·»åŠ åˆ°`span` fiberä¸­çš„`updateQueue`
- æ·»åŠ å‰¯ä½œç”¨ï¼Œä»¥å¤‡æ›´æ–°DOM

åœ¨è¿™äº›æ“ä½œæ‰§è¡Œå‰ï¼Œ`span`FiberèŠ‚ç‚¹çœ‹ä¸Šå»åƒè¿™æ ·ï¼š
```javascript
{
    stateNode: new HTMLSpanElement,
    type: "span",
    effectTag: 0
    updateQueue: null
    ...
}
```

å½“å¤„ç†å®Œæ¯•å®ƒçœ‹ä¸Šå»åƒè¿™æ ·ï¼š
```javascript
{
    stateNode: new HTMLSpanElement,
    type: "span",
    effectTag: 4,
    updateQueue: ["children", "1"],
    ...
}
```

æ³¨æ„`effectTag`å’Œ`updateQueue`å­—æ®µçš„å·®å¼‚ã€‚å®ƒä¸å†æ˜¯`0`ï¼Œå®ƒçš„å€¼æ˜¯`4`ã€‚åœ¨äºŒè¿›åˆ¶ä¸­æ˜¯`100`ï¼Œè¿™è¡¨ç¤ºç¬¬ä¸‰ä¸ªæ¯”ç‰¹ä½è¢«è®¾ç½®ï¼Œè¿™æ°å¥½æ˜¯`Update`side-effect tagçš„æ¯”ç‰¹ä½ã€‚è¿™å°±æ˜¯Reactåœ¨æ¥ä¸‹æ¥çš„`commit`é˜¶æ®µè¦å¤„ç†çš„å·¥ä½œã€‚`updateQueue`å­—æ®µæŒæœ‰æ›´æ–°éœ€è¦çš„æ•°æ®ã€‚

ä¸€æ—¦Reactå¤„ç†`ClickCounter`ä¸å®ƒçš„å­èŠ‚ç‚¹ï¼Œåœ¨renderé˜¶æ®µå®ƒå°±å®Œæˆäº†ã€‚å®ƒç°åœ¨å¯ä»¥å°†`completed alternate tree`èµ‹å€¼ç»™FiberRootçš„finishedWorkå±æ€§ã€‚è¿™æ˜¯éœ€è¦åˆ·æ–°åˆ°å±å¹•çš„æ–°çš„èŠ‚ç‚¹æ ‘ã€‚å®ƒå¯ä»¥åœ¨`render`é˜¶æ®µåè¢«é©¬ä¸Šæ‰§è¡Œï¼Œæˆ–è€…ç¨åå½“æµè§ˆå™¨ç©ºé—²æ—¶å…è®¸Reactæ‰§è¡Œã€‚


## å‰¯ä½œç”¨åˆ—è¡¨

åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œå› ä¸º`span`èŠ‚ç‚¹å’Œ`ClickCounter`ç»„ä»¶æœ‰å‰¯ä½œç”¨ï¼ŒReactå°†ä¼šæŠŠ`span`Fiber èŠ‚ç‚¹é“¾æ¥åˆ°`HostFiber`ä¸­çš„`firstEffect`å±æ€§ã€‚

Reactåœ¨`compliteUnitOfWork`ä¸­åˆ›å»ºå‰¯ä½œç”¨åˆ—è¡¨ã€‚ç±»ä¼¼ä¸‹å›¾æ‰€ç¤ºï¼Œæœ‰ç€å‰¯ä½œç”¨çš„Fiberæ ‘æ›´è¡Œ`span`èŠ‚ç‚¹çš„æ–‡æœ¬å¹¶ä¸”è°ƒç”¨`ClickCounter`çš„é’©å­å‡½æ•°

![](https://res.cloudinary.com/indepth-dev/image/upload/f_auto,fl_lossy,q_auto/local_media/2019/08/image.png)

ä»¥ä¸‹æ˜¯æœ‰ç€å‰¯ä½œç”¨çš„èŠ‚ç‚¹çš„çº¿æ€§åˆ—è¡¨ï¼š
![](https://res.cloudinary.com/indepth-dev/image/upload/f_auto,fl_lossy,q_auto/local_media/2019/08/image-1.png)

---

##Commité˜¶æ®µ

è¿™ä¸ªé˜¶æ®µä»completeRootå‡½æ•°å¼€å§‹ã€‚åœ¨å®ƒè¿›è¡Œä»»ä½•å¤„ç†å·¥ä½œä¹‹å‰ï¼Œå®ƒå°†FiberRootçš„`finishedWork`å±æ€§è®¾ç½®ä¸º`null`:

```javascript
root.finishedWork = null;
```
ä¸åŒäºç¬¬ä¸€æ¬¡`render`é˜¶æ®µï¼Œ`commit`å®ƒæ€»æ˜¯åŒæ­¥çš„ï¼Œå› æ­¤å®ƒå¯ä»¥å®‰å…¨åœ°æ›´æ–°`HostRoot`ï¼Œè¡¨æ˜`commit`å·¥ä½œå¼€å§‹äº†ã€‚

`commit`é˜¶æ®µæ˜¯Reactæ›´æ–°DOMã€è°ƒç”¨å¯ä¼ é€’çªå˜çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•`componentDidUpdate`çš„é˜¶æ®µã€‚åœ¨å¤„ç†çš„æ—¶å€™ï¼Œå®ƒéå†å‰é¢`render`é˜¶æ®µåˆ›å»ºçš„å‰¯ä½œç”¨åˆ—è¡¨å¹¶ä½¿ç”¨ä»–ä»¬ã€‚

å¯¹äºæˆ‘ä»¬çš„`span`å’Œ`ClickCounter`èŠ‚ç‚¹ï¼Œåœ¨`render`é˜¶æ®µæˆ‘ä»¬å¾—åˆ°äº†ä»¥ä¸‹å‰¯ä½œç”¨ï¼š

```javascript
{ type: ClickCounter, effectTag: 5 }
{ type: 'span', effectTag: 4 }
```

`effectTag`çš„å€¼ä¸º`5`ï¼ŒäºŒè¿›åˆ¶è¡¨ç¤ºä¸º`101`ï¼Œå®ƒç•Œå®šäº†è½¬æ¢åˆ°classç»„ä»¶`componentDidUpdate`ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­çš„ `Update`å·¥ä½œã€‚æœ€å³çš„é‚£ä¸ªæ¯”ç‰¹ä½è¿˜ç”¨æ¥æ ‡å¿—â€”â€”åœ¨renderé˜¶æ®µFiberèŠ‚ç‚¹æ‰€æœ‰çš„å·¥ä½œå·²ç»å®Œæˆã€‚

`effectTag`çš„å€¼ä¸º`4`ï¼ŒäºŒè¿›åˆ¶è¡¨ç¤ºä¸º`100`ï¼Œå®ƒç•Œå®šäº†å®¿ä¸»ç»„ä»¶DOMæ›´æ–°æ—¶`Update`å·¥ä½œã€‚å¯¹äº`span`å…ƒç´ è€Œè¨€ï¼ŒReactéœ€è¦ä¸ºå…ƒç´ æ›´æ–°`textContent`


##ä½¿ç”¨å‰¯ä½œç”¨

è®©æˆ‘ä»¬çœ‹çœ‹Reactå¦‚ä½•è¿ç”¨è¿™äº›å‰¯ä½œç”¨ã€‚ç”¨äºæ¶ˆè´¹å‰¯ä½œç”¨çš„[commitRoot](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L523)å‡½æ•°ï¼Œç”±3ä¸ªå­å‡½æ•°ç»„æˆï¼š
```javascript
function commitRoot(root, finishedWork) {
    commitBeforeMutationLifecycles()
    commitAllHostEffects();
    root.current = finishedWork;
    commitAllLifeCycles();
}
```
æ¯ä¸€ä¸ªå­å‡½æ•°éƒ½æ˜¯å…ˆä¸€ä¸ªå¾ªç¯ï¼Œè¯¥å¾ªç¯è¿­ä»£å‰¯ä½œç”¨åˆ—è¡¨å¹¶ä¸”æ£€æŸ¥å‰¯ä½œç”¨ç±»å‹ã€‚å½“å®ƒå‘ç°è¯¥å‰¯ä½œç”¨ç¬¦åˆè¯¥å‡½æ•°çš„ç›®çš„æ—¶ï¼Œå°±åº”ç”¨å®ƒã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå°†ä¼šè°ƒç”¨`ClickCounter`ç»„ä»¶ä¸­çš„`componentDidUpdate`ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œæ›´æ–°`span`å…ƒç´ çš„æ–‡å­—å†…å®¹ã€‚

ç¬¬ä¸€ä¸ªå‡½æ•°[commitBeforeMutationLifeCycles](https://github.com/facebook/react/blob/fefa1269e2a67fa5ef0992d5cc1d6114b7948b7e/packages/react-reconciler/src/ReactFiberCommitWork.js#L183)å¯»æ‰¾[Snapshot](https://github.com/facebook/react/blob/b87aabdfe1b7461e7331abb3601d9e6bb27544bc/packages/shared/ReactSideEffectTags.js#L25)å‰¯ä½œç”¨å¹¶è°ƒç”¨`getSnapshotBeforeUpdate`æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨`ClickCounter`ç»„ä»¶ä¸Šå¹¶æ²¡æœ‰å®ç°æ–¹æ³•ï¼ŒReactåœ¨`render`é˜¶æ®µä¸ä¼šä¸ºæ­¤æ·»åŠ å‰¯ä½œç”¨ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå‡½æ•°ä¸åšä»»ä½•äº‹æƒ…ã€‚

##DOMæ›´æ–°
ä¸‹ä¸€æ­¥Reactç§»æ­¥åˆ°[commitAllHostEffects](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L376)å‡½æ•°ä¸­ã€‚åœ¨è¯¥å‡½æ•°ä¸­Reactå°†`span`å…ƒç´ çš„æ–‡å­—å†…å®¹ä»`0`æ”¹åˆ°`1`ã€‚å› ä¸ºclassç»„ä»¶å¯¹åº”çš„èŠ‚ç‚¹æ²¡æœ‰ä»»ä½•DOMæ›´æ–°ï¼Œæ‰€ä»¥å¯¹`ClickCounter`fiberä¸åšä»»ä½•å¤„ç†ã€‚

è¯¥å‡½æ•°æ„åœ¨é€‰æ‹©æ­£ç¡®çš„å‰¯ä½œç”¨ç±»å‹ï¼Œå¹¶åº”ç”¨åˆ°å¯¹åº”çš„æ“ä½œä¸­ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æˆ‘ä»¬éœ€è¦æ›´æ–°`span`å…ƒç´ çš„æ–‡æœ¬å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„`Update`åˆ†æ”¯å¦‚ä¸‹ï¼š

```javascript
function updateHostEffects() {
    switch (primaryEffectTag) {
      case Placement: {...}
      case PlacementAndUpdate: {...}
      case Update:
        {
          var current = nextEffect.alternate;
          commitWork(current, nextEffect);
          break;
        }
      case Deletion: {...}
    }
}
```

æ‰§è¡Œåˆ°åˆ°`commitWork`å‡½æ•°ï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šè¿›å…¥[updateDOMProperties](https://github.com/facebook/react/blob/8a8d973d3cc5623676a84f87af66ef9259c3937c/packages/react-dom/src/client/ReactDOMComponent.js#L326)å‡½æ•°ã€‚è¯¥å‡½æ•°ä¼ é€’äº†åœ¨`render`é˜¶æ®µæ·»åŠ åˆ°FiberèŠ‚ç‚¹ä¸­çš„`updateQueue`å‚æ•°ï¼Œä¸º`span`å…ƒç´ æ›´æ–°äº†`textContent`å±æ€§ï¼š

```javascript
function updateDOMProperties(domElement, updatePayload, ...) {
  for (let i = 0; i < updatePayload.length; i += 2) {
    const propKey = updatePayload[i];
    const propValue = updatePayload[i + 1];
    if (propKey === STYLE) { ...} 
    else if (propKey === DANGEROUSLY_SET_INNER_HTML) {...} 
    else if (propKey === CHILDREN) {
      setTextContent(domElement, propValue);
    } else {...}
  }
}
```
åœ¨DOMæ›´æ–°å®Œæ¯•åï¼ŒReactå°†`finishedWork`æ ‘é™„åŠ åˆ°`HostRoot`ä¸Šï¼Œå¹¶è®¾ç½®ä¸€ä¸ªalternateæ ‘ä½œä¸ºcurrentæ ‘ï¼š

```javascript
root.current = finishedWork;
```

## è°ƒç”¨èƒ½å¤Ÿä¼ é€’çªå˜çš„ç”Ÿå‘½å‘¨æœŸé’©å­
æœ€åå‰©ä¸‹æ¥çš„å‡½æ•°ä¸º`commitAllLifecycles`ã€‚Reactåœ¨è¿™é‡Œè°ƒç”¨å¯ä»¥ä¼ é€’çªå˜çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚åœ¨`render`é˜¶æ®µï¼ŒReactå¯¹`ClickCounter`ç»„ä»¶æ·»åŠ `Update`å‰¯ä½œç”¨ã€‚è¿™ä¸ªå‰¯ä½œç”¨æ˜¯`commitAllLifecycles`å‡½æ•°å¯»æ‰¾çš„å¹¶è°ƒç”¨`componentDidUpdate`æ–¹æ³•ï¼š

```javascript
function commitAllLifeCycles(finishedRoot, ...) {
    while (nextEffect !== null) {
        const effectTag = nextEffect.effectTag;

        if (effectTag & (Update | Callback)) {
            const current = nextEffect.alternate;
            commitLifeCycles(finishedRoot, current, nextEffect, ...);
        }
        if (effectTag & Ref) {
            commitAttachRef(nextEffect);
        }

        nextEffect = nextEffect.nextEffect;
    }
}
```

å‡½æ•°è¿˜ä¼šæ›´æ–°[refs](https://reactjs.org/docs/refs-and-the-dom.html)ï¼Œä½†æ˜¯ç›®å‰ä¸ºæ­¢æˆ‘ä»¬è¿˜æ²¡æœ‰è¿™ä¸ªæœªç”¨åˆ°çš„åŠŸèƒ½ã€‚è¯¥æ–¹æ³•åœ¨`commitLifeCycles`å‡½æ•°ä¸­è°ƒç”¨ï¼š

```javascript
function commitLifeCycles(finishedRoot, current, ...) {
  ...
  switch (finishedWork.tag) {
    case FunctionComponent: {...}
    case ClassComponent: {
      const instance = finishedWork.stateNode;
      if (finishedWork.effectTag & Update) {
        if (current === null) {
          instance.componentDidMount();
        } else {
          ...
          instance.componentDidUpdate(prevProps, prevState, ...);
        }
      }
    }
    case HostComponent: {...}
    case ...
}
```
ä½ å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿæ˜¯Reactç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶åœ¨ç»„ä»¶ä¸­è°ƒç”¨çš„`componentDidMount`æ–¹æ³•çš„åœ°æ–¹ã€‚

è®²è§£å®Œæ¯•ï¼

---
